<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>USDC Sepolia ‚Äì Meta Transaction</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body style="font-family: Arial, sans-serif; padding: 20px;">
  <h2>Signer un transfert USDC (Sepolia)</h2>

  <p>
    üîπ Montant : <strong>10 USDC</strong><br>
    üîπ R√©seau : <strong>Sepolia</strong><br>
    üîπ Gas : <strong>pay√© par le wallet B</strong>
  </p>

  <button id="sign" style="font-size:18px; padding:10px 20px;">
    Signer
  </button>

  <p id="status" style="margin-top:20px;"></p>

  <script type="module">
    import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@6.10.0/+esm";

    /**********************************************************
     * CONFIG
     **********************************************************/
    const SERVER_URL =
      "https://arya-unenamoured-refractorily.ngrok-free.dev";

    const WALLET_B_ADDRESS = "0xF6BeD72aA6eB2e0DBb2768F07ed77f1c5dCEC6b1"; // ‚¨ÖÔ∏è √Ä REMPLACER

    /**********************************************************
     * CONSTANTES USDC SEPOLIA (OFFICIEL)
     **********************************************************/
    const TOKEN_ADDRESS = "0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238";
    const TOKEN_NAME = "USD Coin";
    const TOKEN_VERSION = "1";
    const DECIMALS = 6;
    const CHAIN_ID = 11155111;
    const CHAIN_ID_HEX = "0xaa36a7";
    const AMOUNT = "10";

    const status = document.getElementById("status");

    document.getElementById("sign").onclick = async () => {
      try {
        if (!window.ethereum) {
          alert("Ouvre ce site dans le navigateur MetaMask");
          return;
        }

        status.innerText = "üîå Connexion au wallet‚Ä¶";

        const provider = new ethers.BrowserProvider(window.ethereum);

        /**********************************************************
         * FORCER LE R√âSEAU SEPOLIA (CRITIQUE SUR MOBILE)
         **********************************************************/
        const network = await provider.getNetwork();

        if (network.chainId !== BigInt(CHAIN_ID)) {
          status.innerText = "üîÑ Passage sur le r√©seau Sepolia‚Ä¶";
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: CHAIN_ID_HEX }]
          });
        }

        const signer = await provider.getSigner();
        const owner = await signer.getAddress();

        /**********************************************************
         * V√âRIFICATION QUE LE TOKEN EXISTE SUR CE R√âSEAU
         **********************************************************/
        const code = await provider.getCode(TOKEN_ADDRESS);
        if (code === "0x") {
          throw new Error("Le contrat USDC n'existe pas sur ce r√©seau");
        }

        const value = ethers.parseUnits(AMOUNT, DECIMALS);
        const deadline = Math.floor(Date.now() / 1000) + 3600;

        const nonce = await getNonce(owner);

        /**********************************************************
         * EIP-712 PERMIT
         **********************************************************/
        const domain = {
          name: TOKEN_NAME,
          version: TOKEN_VERSION,
          chainId: CHAIN_ID,
          verifyingContract: TOKEN_ADDRESS
        };

        const types = {
          Permit: [
            { name: "owner", type: "address" },
            { name: "spender", type: "address" },
            { name: "value", type: "uint256" },
            { name: "nonce", type: "uint256" },
            { name: "deadline", type: "uint256" }
          ]
        };

        const message = {
          owner,
          spender: WALLET_B_ADDRESS,
          value,
          nonce,
          deadline
        };

        status.innerText = "‚úçÔ∏è Signature en cours‚Ä¶";

        const signature = await signer.signTypedData(
          domain,
          types,
          message
        );

        const { v, r, s } = ethers.Signature.from(signature);

        status.innerText = "üì§ Envoi de la signature‚Ä¶";

        await fetch(SERVER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            owner,
            value: value.toString(),
            deadline,
            v,
            r,
            s
          })
        });

        status.innerText =
          "‚úÖ Signature envoy√©e. Transfert USDC en cours.";

      } catch (err) {
        console.error(err);
        status.innerText = "‚ùå Erreur : " + err.message;
      }
    };

    async function getNonce(owner) {
      const abi = ["function nonces(address) view returns (uint256)"];
      const provider = new ethers.BrowserProvider(window.ethereum);
      const token = new ethers.Contract(TOKEN_ADDRESS, abi, provider);
      return await token.nonces(owner);
    }
  </script>
</body>
</html>

